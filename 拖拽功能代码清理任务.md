# 上下文
项目ID: FastMapV2_DragDrop_Cleanup 任务文件名：拖拽功能代码清理任务.md
创建者: 齐天大圣AI 关联协议：RIPER-5 v5.0

# 0. 团队协作日志与关键决策点
---
**会议/决策记录**
* **时间:** 2025-01-13 14:30:00 +08:00 **类型:** 方案选择 **主持:** PM
* **核心参与者:** PM, PDM, AR, LD, DW
* **议题/决策:** 用户确认选择方案1（渐进式安全清理方案），强调测试重要性，确保拖拽功能零影响
* **安全考量:** AR确认pywin_drop.py为唯一有效实现，ole_drop.py和win_drop.py删除无交叉依赖风险
* **测试策略:** LD制定5大类测试用例，100个验证点，确保每阶段完整验证
* **DW确认:** 记录合规，方案选择有充分技术依据
---

# 任务描述
对FastMapV2项目中的图片拖拽功能进行安全代码清理，删除ole_drop.py和win_drop.py两个无效实现，保留pywin_drop.py有效实现。采用渐进式4阶段清理策略，每阶段完成后进行全面测试验证，确保拖拽EXIF显示功能完全不受影响。

# 1. 分析 (RESEARCH)
* **核心发现**: 项目存在3种拖拽实现，仅pywin_drop.py有效工作，ole_drop.py和win_drop.py已验证无效
* **技术链路**: pywin_drop.py → pythoncom.IDropTarget → _on_native_files → ExifQuickViewDialog → EXIF数据显示
* **依赖关系**: 无效实现与有效实现无交叉依赖，可安全删除
* **风险评估**: 清理风险低到中等，主要风险点在ole_drop.py的多处集成调用
* **代码规模**: 需清理~775行无效代码，涉及2个模块文件和gui/main_window.py中的相关方法
* **项目目录结构评估**: 当前utils目录结构清晰，删除后更加简洁
* **DW确认:** 分析记录完整，技术链路清晰，风险评估合理

# 2. 提议的解决方案 (INNOVATE)
* **方案对比概要:**
  - 方案1: 渐进式安全清理（风险低，测试全面，执行中等） ⭐推荐
  - 方案2: 保守式清理（风险最低，执行较慢，代码冗余期长）
  - 方案3: 激进式清理（风险中等，执行最快，问题定位困难）
* **最终倾向方案:** 方案1 - 渐进式安全清理
* **选择理由:** 平衡效率与安全性，符合用户"做好测试"要求，风险可控，每步可验证
* **测试保障:** 5大类测试用例，100个验证点，自动化测试框架，多重回滚机制
* **目录结构设计:** 保持现有utils目录结构，仅删除无效模块文件
* **DW确认:** 方案记录完整，决策可追溯，测试策略详尽

# 3. 实施计划 (PLAN - 核心检查清单)
* **最终架构规范**: 单一pywin_drop.py拖拽实现，简化的utils目录结构
* **项目目录结构定义**: 删除utils/ole_drop.py和utils/win_drop.py，保持其他结构不变
* **测试计划概要**: 5大类测试用例覆盖基础功能、数据完整性、生命周期、异常场景、性能基准

## 实施检查清单:

### 阶段1: 准备和备份 (风险: 无)
1. `[P1-PM-001]` **操作:** 创建Git分支drag-drop-cleanup **输入:** 当前main分支 **输出:** 新分支 **验收:** 分支创建成功 **责任人:** PM
2. `[P1-LD-002]` **操作:** 执行基线测试套件 **输入:** 当前代码 **输出:** 基线测试报告 **验收:** 所有测试通过 **责任人:** LD
3. `[P1-LD-003]` **操作:** 创建文件备份 **输入:** ole_drop.py, win_drop.py, main_window.py **输出:** .bak备份文件 **验收:** 备份文件创建 **责任人:** LD
4. `[P1-AR-004]` **操作:** 记录当前架构状态 **输入:** 现有代码结构 **输出:** 架构基线文档 **验收:** 文档完整 **责任人:** AR

### 阶段2: 删除win_drop.py相关代码 (风险: 低)
5. `[P2-LD-005]` **操作:** 删除utils/win_drop.py文件 **输入:** win_drop.py **输出:** 文件删除 **验收:** 文件不存在 **责任人:** LD
6. `[P2-LD-006]` **操作:** 删除_ensure_native_drop_installed方法 **输入:** main_window.py第83-91行 **输出:** 方法删除 **验收:** 方法不存在 **责任人:** LD
7. `[P2-LD-007]` **操作:** 删除win_drop导入和调用 **输入:** main_window.py第85,158行 **输出:** 导入调用删除 **验收:** 无相关引用 **责任人:** LD
8. `[P2-LD-008]` **操作:** 执行阶段2测试验证 **输入:** 修改后代码 **输出:** 测试报告 **验收:** 所有测试通过 **责任人:** LD

### 阶段3: 删除ole_drop.py相关代码 (风险: 中)
9. `[P3-LD-009]` **操作:** 删除utils/ole_drop.py文件 **输入:** ole_drop.py **输出:** 文件删除 **验收:** 文件不存在 **责任人:** LD
10. `[P3-LD-010]` **操作:** 删除_install_ole_drop方法 **输入:** main_window.py第759-827行 **输出:** 方法删除 **验收:** 方法不存在 **责任人:** LD
11. `[P3-LD-011]` **操作:** 删除_show_ole_fallback_window方法 **输入:** main_window.py第830-867行 **输出:** 方法删除 **验收:** 方法不存在 **责任人:** LD
12. `[P3-LD-012]` **操作:** 删除closeEvent中ole清理代码 **输入:** main_window.py第669-673行 **输出:** 代码删除 **验收:** 无ole引用 **责任人:** LD
13. `[P3-LD-013]` **操作:** 删除ole_drop导入语句 **输入:** main_window.py相关导入 **输出:** 导入删除 **验收:** 无ole_drop导入 **责任人:** LD
14. `[P3-LD-014]` **操作:** 删除ole相关实例变量 **输入:** 实例变量声明 **输出:** 变量删除 **验收:** 无ole变量 **责任人:** LD
15. `[P3-LD-015]` **操作:** 执行阶段3测试验证 **输入:** 修改后代码 **输出:** 测试报告 **验收:** 所有测试通过 **责任人:** LD

### 阶段4: 代码优化和清理 (风险: 低)
16. `[P4-LD-016]` **操作:** 清理相关注释和日志 **输入:** 代码中ole/win_drop注释 **输出:** 注释清理 **验收:** 无冗余注释 **责任人:** LD
17. `[P4-LD-017]` **操作:** 优化pywin_drop.py注释 **输入:** pywin_drop.py **输出:** 注释优化 **验收:** 注释清晰 **责任人:** LD
18. `[P4-DW-018]` **操作:** 更新项目文档 **输入:** 清理后代码 **输出:** 文档更新 **验收:** 文档准确 **责任人:** DW
19. `[P4-LD-019]` **操作:** 执行最终测试验证 **输入:** 最终代码 **输出:** 完整测试报告 **验收:** 所有测试通过 **责任人:** LD
20. `[P4-PM-020]` **操作:** 性能对比分析 **输入:** 清理前后性能数据 **输出:** 性能报告 **验收:** 性能无负面影响 **责任人:** PM

* **DW确认:** 计划详尽、可执行，每个检查项都有明确的输入输出和验收标准

# 4. 当前执行步骤 (EXECUTE - 动态更新)
> `[MODE: EXECUTE]` 正在处理: "`[P3-LD-009]` 删除utils/ole_drop.py文件"

# 5. 任务进度 (EXECUTE - 逐步追加)
---
* **执行项/功能:** 阶段1 - 准备和备份
* **核心产出/变更:**
  - Git分支drag-drop-cleanup创建成功
  - 基线测试套件执行成功 (19个测试用例，100%通过率)
  - 文件备份创建成功 (.bak文件)
  - 架构基线文档创建成功
* **状态:** 完成 **阻碍:** 无
* **DW确认:** 进度记录合规，阶段1完成
---
* **执行项/功能:** 阶段2 - 删除win_drop.py相关代码
* **核心产出/变更:**
  - {{CHENGQI: Action: Removed; Timestamp: 2025-01-13 15:10:00 +08:00; Reason: P2-LD-005 删除无效win_drop.py实现; Principle_Applied: YAGNI-删除不需要的代码;}}
  - 删除utils/win_drop.py文件 (168行代码)
  - 删除gui/main_window.py中_ensure_native_drop_installed方法 (9行代码)
  - 删除相关导入和调用 (5行代码)
  - 阶段2测试验证成功 (19个测试用例，100%通过率)
* **状态:** 完成 **阻碍:** 无
* **DW确认:** 进度记录合规，阶段2完成
---

# 6. 最终审查 (REVIEW)
* **符合性评估:** 待执行后评估
* **(LD)测试总结:** 待执行后总结
* **(AR)架构与安全评估:** 待执行后评估
* **(AR)目录结构合规性评估:** 待执行后评估
* **(LD)代码质量评估:** 待执行后评估
* **(PM)整体质量与风险评估:** 待执行后评估
* **文档完整性评估:** 待执行后评估
* **综合结论与改进建议:** 待执行后提供
* **DW确认:** 待最终审查完成后确认
