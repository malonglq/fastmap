# FastMapV2 XML数据管理需求分析 v2.0

**项目**: FastMapV2 - 对比机Map分析&仿写工具  
**文档类型**: 需求分析文档  
**创建时间**: 2025-07-28  
**作者**: 龙sir团队  
**版本**: v2.0  

## 📋 需求概述

### 业务背景
FastMapV2项目当前在GUI显示XML字段时存在严重的耦合性问题，导致：
- 扩展XML字段需要修改多个文件
- GUI组件与XML数据模型直接耦合
- 缺乏统一的XML读写和数据绑定机制
- 代码维护成本高，扩展性差

### 核心目标
设计并实现可扩展的XML数据管理架构，解决耦合性问题，提供：
1. GUI内XML编辑功能
2. 双向数据绑定机制
3. 数据持久化能力
4. 复制粘贴Map行功能
5. 可扩展的架构设计

## 🎯 功能需求详细分析

### FR-001: GUI内XML编辑功能

#### 需求描述
用户能够在GUI界面直接编辑XML内容，支持实时预览和验证。

#### 详细需求
1. **可编辑表格**
   - map_table_widget.py中的组件支持text编辑功能
   - 支持不同数据类型的内联编辑器
   - 实时数据验证和错误提示
   - 支持键盘快捷键操作

2. **字段编辑器**
   - 文本字段编辑器（支持格式验证）
   - 数值字段编辑器（支持范围验证）
   - 布尔值编辑器（复选框形式）
   - 范围编辑器（min-max双输入框）
   - 坐标编辑器（x,y坐标输入）

3. **编辑体验**
   - 双击单元格进入编辑模式
   - Tab键在字段间切换
   - Enter键确认编辑
   - Esc键取消编辑
   - 支持撤销/重做操作

#### 验收标准
- [ ] 用户可以双击表格单元格进入编辑模式
- [ ] 不同类型字段显示对应的编辑器
- [ ] 编辑时实时验证数据格式
- [ ] 无效数据时显示错误提示
- [ ] 支持键盘快捷键操作

### FR-002: 双向数据绑定机制

#### 需求描述
GUI组件与XML数据之间建立可靠的双向绑定机制，数据变更在用户Ctrl+S后可以保存。

#### 详细需求
1. **数据到GUI绑定**
   - XML数据加载后自动更新GUI显示
   - 支持批量数据更新
   - 保持GUI状态一致性
   - 支持增量更新机制

2. **GUI到数据绑定**
   - GUI编辑后自动更新数据模型
   - 支持实时验证和错误处理
   - 支持批量提交机制
   - Ctrl+S触发数据保存

3. **绑定生命周期**
   - 自动建立绑定关系
   - 自动清理无效绑定
   - 支持动态添加/移除字段
   - 内存泄漏防护

#### 验收标准
- [ ] XML数据加载后GUI自动更新
- [ ] GUI编辑后数据模型自动更新
- [ ] Ctrl+S可以保存所有变更
- [ ] 数据验证失败时阻止保存
- [ ] 绑定关系自动管理，无内存泄漏

### FR-003: 数据持久化

#### 需求描述
XML数据的保存、加载和版本管理。

#### 详细需求
1. **XML保存功能**
   - 保持原XML文件格式和结构
   - 只修改已注册字段的值
   - 支持增量保存和全量保存
   - 自动备份机制

2. **版本管理**
   - 自动创建时间戳备份
   - 支持版本回滚功能
   - 向后兼容性保证
   - 数据迁移机制

3. **错误处理**
   - 保存失败时自动恢复
   - 数据一致性检查
   - 完整的错误日志
   - 用户友好的错误提示

#### 验收标准
- [ ] 保存时保持原XML格式
- [ ] 自动创建备份文件
- [ ] 保存失败时可以恢复
- [ ] 支持不同版本XML格式
- [ ] 完整的错误处理和日志

### FR-004: 复制粘贴Map行功能

#### 需求描述
支持XML数据行级别的复制粘贴操作。

#### 详细需求
1. **复制功能**
   - 右键菜单支持"复制行"
   - 复制包含所有字段的完整数据
   - 支持多行同时复制
   - 复制数据格式化存储

2. **粘贴功能**
   - 右键菜单支持"粘贴行"
   - 自动生成新的Map ID
   - 避免ID冲突和重复
   - 保持XML结构完整性

3. **跨表格支持**
   - 支持在不同表格间复制粘贴
   - 支持跨应用程序复制粘贴
   - 数据格式兼容性处理
   - 字段映射和转换

#### 验收标准
- [ ] 右键菜单包含复制粘贴选项
- [ ] 复制的数据包含所有字段
- [ ] 粘贴时自动生成新ID
- [ ] 支持多行批量操作
- [ ] 跨表格复制粘贴正常工作

### FR-005: 可扩展架构

#### 需求描述
新增XML字段时最小化代码修改范围。

#### 详细需求
1. **字段注册机制**
   - 配置驱动的字段管理
   - 支持运行时字段注册
   - 字段分组和排序
   - 字段可见性控制

2. **动态GUI生成**
   - 根据字段定义自动生成表格列
   - 自动选择合适的编辑器
   - 支持自定义编辑器
   - 动态调整列宽和布局

3. **插件化扩展**
   - 支持字段定义插件
   - 支持编辑器插件
   - 支持验证器插件
   - 支持导入导出插件

#### 验收标准
- [ ] 添加新字段无需修改GUI代码
- [ ] 字段定义通过配置文件管理
- [ ] GUI根据字段定义自动调整
- [ ] 支持自定义编辑器和验证器
- [ ] 插件机制工作正常

## 🔧 非功能需求

### NFR-001: 性能需求

#### 响应时间
- GUI操作响应时间 < 100ms
- XML文件加载时间 < 2s（1000个Map点）
- 数据保存时间 < 1s
- 字段扩展生效时间 < 500ms

#### 吞吐量
- 支持同时编辑100+字段
- 支持1000+Map点数据
- 支持10MB+XML文件
- 支持100+并发绑定

#### 资源使用
- 内存使用 < 500MB（正常使用）
- CPU使用率 < 30%（编辑操作）
- 磁盘空间 < 100MB（备份文件）

### NFR-002: 可用性需求

#### 易用性
- 学习成本 < 30分钟（新用户）
- 操作步骤 < 3步（常用功能）
- 错误恢复时间 < 10s
- 帮助文档完整性 > 95%

#### 可访问性
- 支持键盘快捷键
- 支持高对比度模式
- 支持字体大小调整
- 支持屏幕阅读器

### NFR-003: 可靠性需求

#### 稳定性
- 系统可用性 > 99.9%
- 平均故障间隔时间 > 100小时
- 数据丢失概率 < 0.01%
- 自动恢复成功率 > 95%

#### 数据完整性
- XML结构完整性 100%
- 数据一致性检查
- 自动备份机制
- 错误回滚功能

### NFR-004: 可维护性需求

#### 代码质量
- 代码覆盖率 > 80%
- 圈复杂度 < 10
- 代码重复率 < 5%
- 文档覆盖率 > 90%

#### 扩展性
- 新字段添加时间 < 10分钟
- 代码修改范围最小化
- 向后兼容性保证
- 插件机制支持

## 📊 用户故事

### US-001: 作为开发人员，我希望添加新XML字段时无需修改GUI代码
**场景**: 需要在XML中添加新的detectmap字段
**步骤**:
1. 创建字段定义配置
2. 注册字段到系统
3. GUI自动显示新字段
4. 用户可以编辑新字段

**验收标准**: 整个过程无需修改任何GUI相关代码

### US-002: 作为用户，我希望在表格中直接编辑XML数据
**场景**: 需要修改Map点的权重值
**步骤**:
1. 双击权重列的单元格
2. 输入新的权重值
3. 按Enter确认修改
4. 按Ctrl+S保存到XML文件

**验收标准**: 编辑过程流畅，数据正确保存

### US-003: 作为用户，我希望复制粘贴Map行数据
**场景**: 需要复制一个Map点配置到新位置
**步骤**:
1. 右键点击要复制的行
2. 选择"复制行"菜单
3. 右键点击目标位置
4. 选择"粘贴行"菜单

**验收标准**: 新行数据完整，ID自动生成，无冲突

### US-004: 作为用户，我希望自定义显示哪些字段
**场景**: 只关注部分字段，隐藏不需要的字段
**步骤**:
1. 右键点击表格标题
2. 选择"字段配置"菜单
3. 勾选要显示的字段
4. 点击确定应用配置

**验收标准**: 表格只显示选中的字段，配置可以保存

## 🔍 约束条件

### 技术约束
- 必须基于PyQt5框架
- 必须兼容现有XML格式
- 必须支持Windows开发环境
- 必须使用Python 3.8+

### 业务约束
- 不能破坏现有功能
- 必须保持数据向后兼容
- 必须支持现有工作流程
- 实施期间系统可用

### 资源约束
- 开发时间: 6-8周
- 开发人员: 2-3人
- 测试时间: 2周
- 文档时间: 1周

## ✅ 验收标准总结

### 功能验收
- [ ] 所有功能需求100%实现
- [ ] 用户故事100%通过
- [ ] 集成测试100%通过
- [ ] 用户验收测试通过

### 质量验收
- [ ] 代码覆盖率 > 80%
- [ ] 性能指标达标
- [ ] 安全测试通过
- [ ] 兼容性测试通过

### 文档验收
- [ ] 用户手册完整
- [ ] 开发文档完整
- [ ] API文档完整
- [ ] 部署文档完整

---

**文档状态**: 待确认  
**下次更新**: 根据反馈意见进行需求调整  
**联系人**: 龙sir团队
